{"version":3,"sources":["../../src/controllers/WhatsAppBotController.js"],"names":["dotenv","config","SID","accountSid","KEY","TwilioAuthToken","APIKEY","googleApiKey","CX","cx","APP_ENV","environment","process","env","action_feedbacks","feedback","count","active_intent","MessagingResponse","twilio","twiml","getFeedback","keyword","phone","response","i","feedbacks","length","sub","filter","f","console","log","keywords","includes","toLowerCase","initial_intent","initial_action","getActionFeedback","_feedback","action","q","session_hash","Array","isArray","fb","actionService","previous_action","next_action","WhatsAppBot","googleSearch","req","res","next","body","Body","From","replace","options","auth","session","intent","message","defaultMessage","set","status","send","toString","error"],"mappings":"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","sourcesContent":["import dotenv from 'dotenv';\nimport twilio from 'twilio';\nimport feedbacks from '../messages/feedbacks';\nimport defaultMessage from '../messages/default';\nimport { updateSessionCurrentAction, updateSessionNextAction, getUserSession } from '../models/Session';\n\ndotenv.config();\n\nconst { \n    SID: accountSid,\n    KEY: TwilioAuthToken,\n    APIKEY: googleApiKey,\n    CX: cx,\n    APP_ENV: environment,\n} = process.env;\n\n// var next_action;\nvar action_feedbacks;\nvar feedback;\nvar count;\nvar active_intent = '';\n\ntwilio(accountSid, TwilioAuthToken);\nconst { MessagingResponse } = twilio.twiml;\n\n\nfunction getFeedback(keyword, phone) {\n    let response;\n\n    // console.log({active_intent});\n\n    for(let i = 0; i <= feedbacks.length; i++) {\n        let feedback = feedbacks[i];\n        // console.log(feedback);\n    // feedbacks.forEach((feedback) => {\n        if(active_intent == 'loan' && feedback.sub && feedback.sub.length > 0) {\n            let sub = feedback.sub.filter((f) => {\n                console.log(f.keywords.includes(keyword.toLowerCase()), f.keywords)\n                return f.keywords.includes(keyword.toLowerCase())\n            })[0];\n            // console.log({sub});\n            response = sub;\n            break;\n            // return;\n        } else {\n            if(feedback.keywords.includes(keyword.toLowerCase())) {\n                // console.log('checking here tooo?')\n                response = feedback;\n                break;\n                // return;\n            } else {\n                //set a default response to tell the user we cannot find an appropriate feedback, but they can reach out to a customer care rep\n            }\n        }\n    }\n    //)\n\n    if(response.initial_intent) {\n        //update with the current initial intent\n        active_intent = response.initial_intent;\n    }\n\n    if(response.initial_action) {\n        response.initial_action(phone)\n    }\n\n    // const response = feedbacks.filter(\n    //     (feedback) => \n    //     {\n\n    //     }        \n    //         // feedback.keywords.includes(keyword.toLowerCase())\n    //     )[0];\n\n    //     console.log({active_intent})\n    //     console.log({response});\n    //     if(response.initial_intent) {\n    //         active_intent = response.initial_intent;\n    //     }\n\n    // console.log({response})\n\n    return response;\n    // return response ? response.message : defaultMessage;\n}\n\n\nfunction getActionFeedback(_feedback, action, q, phone, session_hash) {\n    console.log({_feedback})\n//    console.log('checking oooo', _feedback, next_action, action, last_opt);\n\n    // console.log('action', action, count,last_opt)\n\n    let response;\n\n    if(_feedback.action && Array.isArray(_feedback.action)) {\n         response = _feedback.action.filter(\n                (fb) => {\n                    // let ac = fb.action ? fb.action : fb;\n                    // console.log({ac}, action);\n                    // console.log('act=>', ac == action && action)\n                return fb.action == action;\n                }\n            )[0];\n\n        // if(response.feedback) {\n        //     console.log({q})\n        //     _next_action = response.feedback.filter(fb => { \n        //         console.log({fb})\n        //        return fb.input == q\n        //     })[0];\n\n        //     if(_next_action) {\n        //         response.next_action = _next_action;\n        //     }\n        // }\n        // console.log(response, 'me');\n    } else {\n        response = _feedback.filter((fb) => fb.action == action)[0];\n        // console.log(response, 'action');\n    }\n\n    if(response.actionService) {\n        console.log(response)\n        response.actionService(phone, response.previous_action, response.next_action, q, session_hash);\n    }\n\n    updateSessionCurrentAction(phone, response.action);\n    updateSessionNextAction(phone, response.next_action);\n\n    // console.log('action_response', response);\n    // console.log('new resp', q, next_action, response)\n    return response\n    // next_action = response.next_action\n\n}\n\n\nclass WhatsAppBot {\n\n    static async googleSearch(req, res, next) {\n        console.log(req.body);\n        const twiml = new MessagingResponse();\n        const q = req.body.Body;\n        const phone = req.body.From ? req.body.From.replace('whatsapp:', '') : null;\n        const options = { cx, q, auth: googleApiKey}\n\n        try {\n            let response;\n            let feedback;\n            let next_action;\n            \n            const session = await getUserSession(phone);\n            if(session && session.next_action !== 'undefined') {\n                next_action = session.next_action;                \n            }\n\n\n            console.log({next_action})\n\n            if(next_action) {\n                feedback = getActionFeedback(action_feedbacks, next_action, q, phone, session.session_hash);\n                console.log({feedback});\n                // next_action = feedback.next_action;\n                updateSessionNextAction(feedback.next_action);\n    \n            } else {                \n                feedback = getFeedback(q, phone);\n                // console.log({feedback})\n\n                if(feedback.action) {\n                    action_feedbacks = feedback.action;\n                }\n            }\n\n\n\n            if(feedback.intent) {\n                response = getActionFeedback(feedback, feedback.intent, q, phone, session.session_hash);\n                // next_action = response.next_action\n                 updateSessionNextAction(feedback.next_action);\n                // console.log({response});\n            } else {\n                response = feedback;\n                // console.log('backup response', response.message)\n            }\n\n\n            let message = `${response ? response.message : defaultMessage}`;\n\n            count++;\n\n            if(environment == 'production') {\n               twiml.message(`${message}`);\n     \n               console.log(message);\n               res.set('Content-Type', 'text/xml');\n               return res.status(200).send(twiml.toString());\n            } else {\n                res.set('Content-Type', 'application/json');\n                return res.status(200).send({message});\n            }\n\n            // let next_action = getUserSession(phone).next_action;\n\n\n            // console.log({next_action});\n            \n\n        } catch(error) {\n            console.log({error})\n            return next(error);\n        }\n    }\n\n\n}\n\nexport default WhatsAppBot;"],"file":"WhatsAppBotController.js"}